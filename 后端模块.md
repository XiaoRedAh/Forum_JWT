# 账号信息设置

## 前置准备工作

db_account_details数据表存放账号详细信息
```sql
CREATE TABLE db_account_details  (
  `id` int NOT NULL,
  `gender` tinyint(255) NULL,
  `phone` varchar(255) NULL,
  `qq` varchar(255) NULL,
  `wx` varchar(255) NULL,
  `desc` varchar(255) NULL,
  PRIMARY KEY (`id`)
);
```

easycode插件自动生成对应的实体类，service，serviceimpl，mapper

```java
/**
 * (AccountDetails)表实体类
 *
 * @author makejava
 * @since 2023-08-29 15:52:08
 */
@SuppressWarnings("serial")
@Data
@AllArgsConstructor
@NoArgsConstructor
@TableName("db_account_details")
public class AccountDetails implements BaseData {
    @TableId
    private Integer id;
    private Integer gender;
    private String phone;
    private String qq;
    private String wx;
    @TableField("`desc`") //desc是sql语句的关键字，需要区分一下
    private String desc;
}

```

## 展示详细信息

com/xiaoRed/entity/vo/response/AccountDetailsVo.java
数据库查询到用户详细信息，封装为AccountDetailsVo对象返回给前端
```java
/**
 * 数据库查询到用户详细信息，封装为vo对象返回给前端
 */
@Data
public class AccountDetailsVo {
    private Integer gender;
    private String phone;
    private String qq;
    private String wx;
    private String desc;
}
```

com/xiaoRed/controller/AccountController.java
```java
    /**
     * 获取用户详细信息，封装为vo对象，展示到前端
     * @param id JwtAuthorizeFilter已经往请求域中塞进了用户id，直接从请求域里取出来就行
     * @return
     */
    @GetMapping("/details")
    public RestBean<AccountDetailsVo> details(@RequestAttribute(Const.ATTR_USER_ID) int id){
        //如果之前没有保存过账户详细信息，数据表中是没有对应id的数据的，这时new一个空的即可
        AccountDetails accountDetails = Optional.
                ofNullable(accountDetailsService.findAccountDetailsById(id))
                .orElseGet(AccountDetails::new);
        return RestBean.success(accountDetails.asViewObject(AccountDetailsVo.class));
    }
```

com/xiaoRed/service/impl/AccountDetailsServiceImpl.java
```java
    /**
     * 通过用户id从表中找到该条记录并返回给前端显示
     * @param id 用户id
     * @return
     */
    @Override
    public AccountDetails findAccountDetailsById(int id) {
        return this.getById(id);
    }
```

## 保存详细信息

com/xiaoRed/entity/vo/request/DetailsSaveVo.java
将请求中携带的账户信息设置提交的内容封装为一个DetailsSaveVo对象
```java
/**
 * 账户信息设置提交的内容封装为一个vo
 */
@Data
@AllArgsConstructor
@NoArgsConstructor
public class DetailsSaveVo {
    @Pattern(regexp = "^[a-zA-Z0-9\\u4e00-\\u9fa5]+$")//不允许包含特殊字符
    @Length(min = 1, max = 10)
    private String username;
    //0表示男，1表示女
    @Max(1)
    @Min(0)
    private Integer gender;
    @Length(max = 11)
    private String phone;
    @Length(max = 13)
    private String qq;
    @Length(max = 20)
    private String wx;
    @Length(max = 200)
    private String desc;
}
```

com/xiaoRed/controller/AccountController.java
```java
    /**
     * 保存账户详细信息
     * @param id JwtAuthorizeFilter已经往请求域中塞进了用户id，直接从请求域里取出来就行
     * @param vo 前端保存账户详细信息表单提交的内容封装为一个vo
     * @return
     */
    @PostMapping("/save-details")
    public RestBean<Void> saveDetails(@RequestAttribute(Const.ATTR_USER_ID) int id, @RequestBody @Valid DetailsSaveVo vo){
        boolean isSuccess = accountDetailsService.saveAccountDetails(id, vo);
        return  isSuccess ? RestBean.success() : RestBean.failure(400, "此用户名已被其他用户使用，请重新设置");
    }
```

com/xiaoRed/service/impl/AccountDetailsServiceImpl.java
```java
    /**
     * 保存账户详细信息，涉及到改两张表
     * 改用户名涉及到db_account表，其他的涉及db_account_details表
     * @param id 用户id
     * @param vo 前端提交的账户详细信息表单
     * @return 是否保存成功
     */
    @Override
    public boolean saveAccountDetails(int id, DetailsSaveVo vo) {
        Account account = accountService.findAccountByNameOrEmail(vo.getUsername()); //从用户表中查有无同名的用户
        if(account == null || account.getId() == id){ //如果没有同名用户或同名用户就是自己，才可以进一步地修改
            //db_account表中修改用户名
            accountService.update()
                    .eq("id", id)
                    .set("username", vo.getUsername())
                    .update();
            //db_account_details表中修改用户详细信息。如果表中无对应id数据，则插入，否则更新
            this.saveOrUpdate(new AccountDetails(id, vo.getGender(), vo.getPhone(), vo.getQq(),
                    vo.getWx(), vo.getDesc()));
            return true;
        }
        return false;
    }
```

